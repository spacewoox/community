version: '2'

services:
  guacamole-client:
   build: ./canva/guacamole-client
   restart: always
   container_name: "guacamole-client"
   networks:
    - nanocloud

  guacamole-server:
   image: glyptodon/guacd:0.9.8
   restart: always
   container_name: "guacamole-server"
   networks:
    - nanocloud
  nanocloud-backend:
   build: ../nanocloud
   environment:
    - ENV=production
    - AMQP_URI=amqp://guest:guest@rabbitmq:5672/
    - DATABASE_URI=postgres://nanocloud@postgres/nanocloud?sslmode=disable
    - PORT=8080
    - FRONT_DIR=/opt/front/website
    - WIN_PASSWORD=Nanocloud123+
    - WIN_PORT=1119
    - WIN_USER=Administrator
    - WIN_SERVER=iaas-module
   restart: always
   container_name: "nanocloud-api"
   networks:
    - nanocloud
   volumes_from:
    - nanocloud-frontend

  nanocloud-frontend:
   build: ../webapp
   container_name: "nanocloud-webapp"
   volumes:
    - /opt/front
   networks:
    - nanocloud

  proxy:
   image: nginx:1.9
   volumes:
    - ./nginx/conf/nginx.conf:/etc/nginx/conf.d/default.conf:ro
    - ./nginx/conf/certificates:/etc/nginx/ssl/:ro
   ports:
    - 80:80
    - 443:443
   restart: always
   container_name: "proxy"
   networks:
    - nanocloud

  rabbitmq:
   image: rabbitmq:3.5
   restart: always
   container_name: "rabbitmq"
   networks:
    - nanocloud

  postgres:
   image: postgres:9.4
   environment:
    - PGDATA=/var/lib/postgresql/data/pgdata
    - POSTGRES_USER=nanocloud
   restart: always
   container_name: "postgres"
   networks:
    - nanocloud

  apps-module:
   build: ./apps
   environment:
    - ENV=production
    - AMQP_URI=amqp://guest:guest@rabbitmq:5672/
    - DATABASE_URI=postgres://nanocloud@postgres/nanocloud?sslmode=disable
    - USER=Administrator
    - SSH_PORT=1119
    - RDP_PORT=3389
    - SERVER=iaas-module
    - PASSWORD=Nanocloud123+
    - WINDOWS_DOMAIN=intra.localdomain.com
    - EXECUTION_SERVERS=iaas-module
   restart: always
   container_name: "apps-module"
   networks:
    - nanocloud

  history-module:
   build: ./history
   environment:
    - ENV=production
    - AMQP_URI=amqp://guest:guest@rabbitmq:5672/
    - DATABASE_URI=postgres://nanocloud@postgres/nanocloud?sslmode=disable
   restart: always
   container_name: "history-module"
   networks:
    - nanocloud

  iaas-module:
   build: ./iaas
   environment:
    - ENV=production
    - AMQP_URI=amqp://guest:guest@rabbitmq:5672/
    - INSTALLATION_DIR=/var/lib/nanocloud
    - SSH_PORT=1119
    - PASSWORD=Nanocloud123+
    - SERVER=localhost
    - USER=Administrator
    - ARTIFACT_URL=http://releases.nanocloud.org:8080/releases/0.2.1/
   volumes:
    - ../installation_dir:/var/lib/nanocloud/
   restart: always
   container_name: "iaas-module"
   privileged: true
   networks:
    - nanocloud

  ldap-module:
   build: ./ldap
   environment:
    - ENV=production
    - AMQP_URI=amqp://guest:guest@rabbitmq:5672/
    - LDAP_SERVER_URI=ldaps://Administrator:Nanocloud123+@iaas-module:6360
    - BASE=DC=intra,DC=localdomain,DC=com
    - LDAP_USERNAME=CN=Administrator,CN=Users,DC=intra,DC=localdomain,DC=com
    - BIND_DN=CN=Administrator,DC=intra,DC=localdomain,DC=com
    - PASSWORD=
   restart: always
   container_name: "ldap-module"
   networks:
    - nanocloud

  users-module:
   build: ./users
   environment:
    - ENV=production
    - AMQP_URI=amqp://guest:guest@rabbitmq:5672/
    - DATABASE_URI=postgres://nanocloud@postgres/nanocloud?sslmode=disable
   restart: always
   container_name: "users-module"
   networks:
    - nanocloud

networks:
 nanocloud:
  driver: bridge